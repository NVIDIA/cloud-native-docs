<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GPU Operator with Kata Containers &mdash; NVIDIA GPU Operator 24.6.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" type="text/css" />
      <link rel="stylesheet" href="_static/omni-style.css" type="text/css" />
      <link rel="stylesheet" href="_static/api-styles.css" type="text/css" />
      <link rel="stylesheet" href="_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/mermaid-init.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
        <script src="_static/design-tabs.js"></script>
        <script crossorigin="anonymous" integrity="sha256-QdTG1YTLLTwD3b95jLqFxpQX9uYuJMNAtVZgwKX4oYU=" src="https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js"></script>
        <script src="_static/mermaid-init.js"></script>
        <script src="_static/version.js"></script>
        <script src="_static/social-media.js"></script>
        <script>initMermaid();</script>
    <script src="_static/js/theme.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="GPU Operator with Confidential Containers and Kata" href="gpu-operator-confidential-containers.html" />
    <link rel="prev" title="GPU Operator with KubeVirt" href="gpu-operator-kubevirt.html" />
 


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >


<a href="index.html">
  <img src="_static/nvidia-logo-white.png" class="logo" alt="Logo"/>
</a>

<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">NVIDIA GPU Operator</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">About the Operator</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrade.html">Upgrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="uninstall.html">Uninstall</a></li>
<li class="toctree-l1"><a class="reference internal" href="platform-support.html">Platform Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu-driver-upgrades.html">GPU Driver Upgrades</a></li>
<li class="toctree-l1"><a class="reference internal" href="install-gpu-operator-vgpu.html">Using NVIDIA vGPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="install-gpu-operator-nvaie.html">NVIDIA AI Enterprise</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Operator Configuration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="gpu-operator-mig.html">Multi-Instance GPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu-sharing.html">Time-Slicing GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu-operator-rdma.html">GPUDirect RDMA and GPUDirect Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="install-gpu-operator-outdated-kernels.html">Outdated Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom-driver-params.html">Custom GPU Driver Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="precompiled-drivers.html">Precompiled Driver Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu-driver-configuration.html">GPU Driver CRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="cdi.html">Container Device Interface Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Sandboxed Workloads</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="gpu-operator-kubevirt.html">KubeVirt</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Kata Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu-operator-confidential-containers.html">Confidential Containers and Kata</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Specialized Networks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install-gpu-operator-proxy.html">HTTP Proxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="install-gpu-operator-air-gapped.html">Air-Gapped Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="install-gpu-operator-service-mesh.html">Service Mesh</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CSP configurations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="amazon-eks.html">Amazon EKS</a></li>
<li class="toctree-l1"><a class="reference internal" href="microsoft-aks.html">Azure AKS</a></li>
<li class="toctree-l1"><a class="reference internal" href="google-gke.html">Google GKE</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">NVIDIA GPU Operator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
<li>
    <a href="https://docs.nvidia.com">NVIDIA Docs Hub</a>
    <i class="fa fa-chevron-right" aria-hidden="true"></i>
</li>
<li>
    <a href="https://docs.nvidia.com/datacenter/cloud-native/">NVIDIA Cloud Native Technologies</a>
    <i class="fa fa-chevron-right" aria-hidden="true"></i>
</li>
<li>GPU Operator with Kata Containers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="gpu-operator-with-kata-containers">
<h1>GPU Operator with Kata Containers<a class="headerlink" href="#gpu-operator-with-kata-containers" title="Permalink to this headline"></a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#about-the-operator-with-kata-containers" id="id2">About the Operator with Kata Containers</a></p>
<ul>
<li><p><a class="reference internal" href="#about-nvidia-kata-manager" id="id3">About NVIDIA Kata Manager</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#benefits-of-using-kata-containers" id="id4">Benefits of Using Kata Containers</a></p></li>
<li><p><a class="reference internal" href="#limitations-and-restrictions" id="id5">Limitations and Restrictions</a></p></li>
<li><p><a class="reference internal" href="#cluster-topology-considerations" id="id6">Cluster Topology Considerations</a></p></li>
<li><p><a class="reference internal" href="#prerequisites" id="id7">Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#overview-of-installation-and-configuration" id="id8">Overview of Installation and Configuration</a></p></li>
<li><p><a class="reference internal" href="#kata-deploy-helm-chart-customizations" id="id9">Kata Deploy Helm Chart Customizations</a></p></li>
<li><p><a class="reference internal" href="#install-the-kata-deploy-helm-chart" id="id10">Install the Kata Deploy Helm Chart</a></p></li>
<li><p><a class="reference internal" href="#install-the-nvidia-gpu-operator" id="id11">Install the NVIDIA GPU Operator</a></p>
<ul>
<li><p><a class="reference internal" href="#procedure" id="id12">Procedure</a></p></li>
<li><p><a class="reference internal" href="#verification" id="id13">Verification</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#run-a-sample-workload" id="id14">Run a Sample Workload</a></p>
<ul>
<li><p><a class="reference internal" href="#troubleshooting-workloads" id="id15">Troubleshooting Workloads</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#about-the-pod-annotation" id="id16">About the Pod Annotation</a></p></li>
</ul>
</div>
<section id="about-the-operator-with-kata-containers">
<h2>About the Operator with Kata Containers<a class="headerlink" href="#about-the-operator-with-kata-containers" title="Permalink to this headline"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Technology Preview features are not supported in production environments
and are not functionally complete.
Technology Preview features provide early access to upcoming product features,
enabling customers to test functionality and provide feedback during the development process.
These releases may not have any documentation, and testing is limited.</p>
</div>
<p>Kata Containers are similar, but subtly different from traditional containers such as a Docker container.</p>
<p>A traditional container packages software for user-space isolation from the host,
but the container runs on the host and shares the operating system kernel with the host.
Sharing the operating system kernel is a potential vulnerability.</p>
<p>A Kata container runs in a virtual machine on the host.
The virtual machine has a separate operating system and operating system kernel.
Hardware virtualization and a separate kernel provide improved workload isolation
in comparison with traditional containers.</p>
<p>The NVIDIA GPU Operator works with the Kata container runtime.
Kata uses a hypervisor, like QEMU, to provide a lightweight virtual machine with a single purpose–to run a Kubernetes pod.</p>
<p>The following diagram shows the software components that Kubernetes uses to run a Kata container.</p>
<figure class="align-default" id="id1">
<div data-mermaid="flowchart LR
  a[Kubelet] --&gt; b[CRI] --&gt; c[Kata\nRuntime] --&gt; d[Lightweight\nQEMU VM] --&gt; e[Lightweight\nGuest OS] --&gt; f[Pod] --&gt; g[Container]"><div class="mermaid">
            flowchart LR
  a[Kubelet] --&gt; b[CRI] --&gt; c[Kata\nRuntime] --&gt; d[Lightweight\nQEMU VM] --&gt; e[Lightweight\nGuest OS] --&gt; f[Pod] --&gt; g[Container]
        </div></div><figcaption>
<p><span class="caption-text">Software Components with Kata Container Runtime</span><a class="headerlink" href="#id1" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>NVIDIA supports Kata Containers by using Helm to run a daemon set that installs the Kata runtime and QEMU.</p>
<p>The daemon set runs the <code class="docutils literal notranslate"><span class="pre">kata-deploy.sh</span></code> script and configures each worker node with a runtime class, <code class="docutils literal notranslate"><span class="pre">kata-qemu-nvidia-gpu</span></code>.</p>
<section id="about-nvidia-kata-manager">
<h3>About NVIDIA Kata Manager<a class="headerlink" href="#about-nvidia-kata-manager" title="Permalink to this headline"></a></h3>
<p>When you configure the GPU Operator for Kata Containers, the Operator
deploys NVIDIA Kata Manager as an operand.</p>
<p>The manager performs the following actions on each node that is labeled to run Kata Containers:</p>
<ul class="simple">
<li><p>Configure containerd with the <code class="docutils literal notranslate"><span class="pre">kata-qemu-nvidia-gpu</span></code> runtime class.</p></li>
<li><p>Create a CDI specification, <code class="docutils literal notranslate"><span class="pre">/var/run/cdi/nvidia.com-pgpu.yaml</span></code>, for each GPU on the node.</p></li>
<li><p>Loads the vhost-sock and vhost-net Linux kernel modules.</p></li>
</ul>
</section>
</section>
<section id="benefits-of-using-kata-containers">
<h2>Benefits of Using Kata Containers<a class="headerlink" href="#benefits-of-using-kata-containers" title="Permalink to this headline"></a></h2>
<p>The primary benefits of Kata Containers are as follows:</p>
<ul class="simple">
<li><p>Running untrusted workloads in a container.
The virtual machine provides a layer of defense against the untrusted code.</p></li>
<li><p>Limiting access to hardware devices such as NVIDIA GPUs.
The virtual machine is provided access to specific devices.
This approach ensures that the workload cannot access additional devices.</p></li>
<li><p>Transparent deployment of unmodified containers.</p></li>
</ul>
</section>
<section id="limitations-and-restrictions">
<h2>Limitations and Restrictions<a class="headerlink" href="#limitations-and-restrictions" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>GPUs are available to containers as a single GPU in passthrough mode only.
Multi-GPU passthrough and vGPU are not supported.</p></li>
<li><p>Support is limited to initial installation and configuration only.
Upgrade and configuration of existing clusters for Kata Containers is not supported.</p></li>
<li><p>Support for Kata Containers is limited to the implementation described on this page.
The Operator does not support Red Hat OpenShift sandbox containers.</p></li>
<li><p>Uninstalling the GPU Operator or the NVIDIA Kata Manager does not remove the
<code class="docutils literal notranslate"><span class="pre">/opt/nvidia-gpu-operator/artifacts/runtimeclasses/</span></code>
directory on the worker nodes.</p></li>
<li><p>NVIDIA supports the Operator and Kata Containers with the containerd runtime only.</p></li>
</ul>
</section>
<section id="cluster-topology-considerations">
<h2>Cluster Topology Considerations<a class="headerlink" href="#cluster-topology-considerations" title="Permalink to this headline"></a></h2>
<p>You can configure all the worker nodes in your cluster for Kata Containers or you configure some
nodes for Kata Containers and the others for traditional containers.
Consider the following example.</p>
<p>Node A is configured to run traditional containers.</p>
<p>Node B is configured to run Kata Containers.</p>
<p>Node A receives the following software components:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NVIDIA</span> <span class="pre">Driver</span> <span class="pre">Manager</span> <span class="pre">for</span> <span class="pre">Kubernetes</span></code> – to install the data-center driver.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NVIDIA</span> <span class="pre">Container</span> <span class="pre">Toolkit</span></code> – to ensure that containers can access GPUs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NVIDIA</span> <span class="pre">Device</span> <span class="pre">Plugin</span> <span class="pre">for</span> <span class="pre">Kubernetes</span></code> – to discover and advertise GPU resources to kubelet.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NVIDIA</span> <span class="pre">DCGM</span> <span class="pre">and</span> <span class="pre">DCGM</span> <span class="pre">Exporter</span></code> – to monitor GPUs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NVIDIA</span> <span class="pre">MIG</span> <span class="pre">Manager</span> <span class="pre">for</span> <span class="pre">Kubernetes</span></code> – to manage MIG-capable GPUs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Node</span> <span class="pre">Feature</span> <span class="pre">Discovery</span></code> – to detect CPU, kernel, and host features and label worker nodes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NVIDIA</span> <span class="pre">GPU</span> <span class="pre">Feature</span> <span class="pre">Discovery</span></code> – to detect NVIDIA GPUs and label worker nodes.</p></li>
</ul>
<p>Node B receives the following software components:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NVIDIA</span> <span class="pre">Kata</span> <span class="pre">Manager</span> <span class="pre">for</span> <span class="pre">Kubernetes</span></code> – to manage the NVIDIA artifacts such as the
NVIDIA optimized Linux kernel image and initial RAM disk.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NVIDIA</span> <span class="pre">Sandbox</span> <span class="pre">Device</span> <span class="pre">Plugin</span></code> – to discover and advertise the passthrough GPUs to kubelet.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NVIDIA</span> <span class="pre">VFIO</span> <span class="pre">Manager</span></code> – to load the vfio-pci device driver and bind it to all GPUs on the node.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Node</span> <span class="pre">Feature</span> <span class="pre">Discovery</span></code> – to detect CPU security features, NVIDIA GPUs, and label worker nodes.</p></li>
</ul>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline"></a></h2>
<ul>
<li><p>Your hosts are configured to enable hardware virtualization and Access Control Services (ACS).
With some AMD CPUs and BIOSes, ACS might be grouped under Advanced Error Reporting (AER).
Enabling these features is typically performed by configuring the host BIOS.</p></li>
<li><p>Your hosts are configured to support IOMMU.</p>
<p>If the output from running <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-1</span> <span class="pre">/sys/kernel/iommu_groups</span> <span class="pre">|</span> <span class="pre">wc</span> <span class="pre">-l</span></code> includes a value greater than <code class="docutils literal notranslate"><span class="pre">0</span></code>,
then your host is configured for IOMMU.</p>
<p>If a host is not configured or you are unsure, add the <code class="docutils literal notranslate"><span class="pre">intel_iommu=on</span></code> Linux kernel command-line argument.
For most Linux distributions, you add the argument to the <code class="docutils literal notranslate"><span class="pre">/etc/default/grub</span></code> file:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>...
GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet intel_iommu=on modprobe.blacklist=nouveau&quot;
...
</pre></div>
</div>
<p>On Ubuntu systems, run <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">update-grub</span></code> after making the change to configure the bootloader.
On other systems, you might need to run <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">dracut</span></code> after making the change.
Refer to the documentation for your operating system.
Reboot the host after configuring the bootloader.</p>
</li>
<li><p>You have a Kubernetes cluster and you have cluster administrator privileges.</p></li>
</ul>
</section>
<section id="overview-of-installation-and-configuration">
<h2>Overview of Installation and Configuration<a class="headerlink" href="#overview-of-installation-and-configuration" title="Permalink to this headline"></a></h2>
<p>Installing and configuring your cluster to support the NVIDIA GPU Operator with Kata Containers is as follows:</p>
<ol class="arabic">
<li><p>Label the worker nodes that you want to use with Kata Containers.</p>
<p>This step ensures that you can continue to run traditional container workloads with GPU or vGPU workloads on some nodes in your cluster.
Alternatively, you can set the default sandbox workload to <code class="docutils literal notranslate"><span class="pre">vm-passthrough</span></code> to run confidential containers on all worker nodes.</p>
</li>
<li><p>Install the Kata Deploy Helm chart.</p>
<p>This step runs <code class="docutils literal notranslate"><span class="pre">kata-deploy.sh</span></code> on each node and installs the Kata Containers runtime on each node.</p>
</li>
<li><p>Install the NVIDIA GPU Operator.</p>
<p>You install the Operator and specify options to deploy the operands that are required for Kata Containers.</p>
</li>
</ol>
<p>After installation, you can run a sample workload.</p>
</section>
<section id="kata-deploy-helm-chart-customizations">
<h2>Kata Deploy Helm Chart Customizations<a class="headerlink" href="#kata-deploy-helm-chart-customizations" title="Permalink to this headline"></a></h2>
<p>The following table shows the configurable values from the Kata Deploy Helm chart.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 50%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Default</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">kataDeploy.allowedHypervisorAnnotations</span></code></p></td>
<td><p>Specifies the
<a class="reference external" href="https://github.com/kata-containers/kata-containers/blob/main/docs/how-to/how-to-set-sandbox-config-kata.md#hypervisor-options">hypervisor annotations</a>
to enable in the Kata configuration file on each node.
Specify a space-separated string of values such as <code class="docutils literal notranslate"><span class="pre">enable_iommu</span> <span class="pre">initrd</span> <span class="pre">kernel</span></code>.</p></td>
<td><p>None</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">kataDeploy.createRuntimeClasses</span></code></p></td>
<td><p>When set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, the <code class="docutils literal notranslate"><span class="pre">kata-deploy.sh</span></code> script installs the runtime classes on the nodes.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">kataDeploy.createDefaultRuntimeClass</span></code></p></td>
<td><p>When set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, the <code class="docutils literal notranslate"><span class="pre">kata-deploy.sh</span></code> script sets the runtime class specified in the <code class="docutils literal notranslate"><span class="pre">defaultShim</span></code> field as the default Kata runtime class.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">kataDeploy.debug</span></code></p></td>
<td><p>When set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, the <code class="docutils literal notranslate"><span class="pre">kata-deploy.sh</span></code> script enables debugging and a debug console in the Kata configuration file on each node.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">kataDeploy.defaultShim</span></code></p></td>
<td><p>Specifies the shim to set as the default Kata runtime class.
This field is ignored unless you specify <code class="docutils literal notranslate"><span class="pre">createDefaultRuntimeClass:</span> <span class="pre">true</span></code>.</p></td>
<td><p>None</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">kataDeploy.imagePullPolicy</span></code></p></td>
<td><p>Specifies the image pull policy for the <code class="docutils literal notranslate"><span class="pre">kata-deploy</span></code> container.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Always</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">kataDeploy.k8sDistribution</span></code></p></td>
<td><p>Specifies the Kubernetes platform.
The Helm chart uses the value to set the platform-specific location of the containerd configuration file.</p>
<p>Supported values are <code class="docutils literal notranslate"><span class="pre">k8s</span></code>, <code class="docutils literal notranslate"><span class="pre">k3s</span></code>, <code class="docutils literal notranslate"><span class="pre">rke2</span></code>, and <code class="docutils literal notranslate"><span class="pre">k0s</span></code>.</p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">k8s</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">kataDeploy.repository</span></code></p></td>
<td><p>Specifies the image repository for the <code class="docutils literal notranslate"><span class="pre">kata-deploy</span></code> container.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nvcr.io/nvidia/cloud-native</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">kataDeploy.shims</span></code></p></td>
<td><p>Specifies the shim binaries to install on each node.
Specify a space-separated string of values.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">qemu-nvidia-gpu</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">kataDeploy.version</span></code></p></td>
<td><p>Specifies the version of the <code class="docutils literal notranslate"><span class="pre">kata-deploy</span></code> container to run.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">latest</span></code></p></td>
</tr>
</tbody>
</table>
</section>
<section id="install-the-kata-deploy-helm-chart">
<h2>Install the Kata Deploy Helm Chart<a class="headerlink" href="#install-the-kata-deploy-helm-chart" title="Permalink to this headline"></a></h2>
<p>Perform the following steps to install the Helm chart:</p>
<ol class="arabic">
<li><p>Label the nodes to run virtual machines in containers. Label only the nodes that you want to run with Kata Containers:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl label node &lt;node-name&gt; nvidia.com/gpu.workload.config<span class="o">=</span>vm-passthrough
</pre></div>
</div>
</li>
<li><p>Add and update the NVIDIA Helm repository:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>helm repo add nvidia https://helm.ngc.nvidia.com/nvidia <span class="se">\</span>
   <span class="o">&amp;&amp;</span> helm repo update
</pre></div>
</div>
</li>
<li><p>Specify at least the following options when you install the chart:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>helm install --wait --generate-name <span class="se">\</span>
   -n kube-system <span class="se">\</span>
   nvidia/kata-deploy <span class="se">\</span>
   --set kataDeploy.createRuntimeClasses<span class="o">=</span><span class="nb">true</span>
</pre></div>
</div>
</li>
<li><p>Optional: Verify the installation.</p>
<ul>
<li><p>Confirm the <code class="docutils literal notranslate"><span class="pre">kata-deploy</span></code> containers are running:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl get pods -n kube-system -l <span class="nv">name</span><span class="o">=</span>kata-deploy
</pre></div>
</div>
</li>
<li><p>Confirm the runtime class is installed:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl get runtimeclass kata-qemu-nvidia-gpu
</pre></div>
</div>
<p><em>Example Output</em></p>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">NAME                   HANDLER                AGE</span>
<span class="go">kata-qemu-nvidia-gpu   kata-qemu-nvidia-gpu   23s</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ol>
</section>
<section id="install-the-nvidia-gpu-operator">
<h2>Install the NVIDIA GPU Operator<a class="headerlink" href="#install-the-nvidia-gpu-operator" title="Permalink to this headline"></a></h2>
<section id="procedure">
<h3>Procedure<a class="headerlink" href="#procedure" title="Permalink to this headline"></a></h3>
<p>Perform the following steps to install the Operator for use with Kata Containers:</p>
<ol class="arabic">
<li><p>Add and update the NVIDIA Helm repository:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>helm repo add nvidia https://helm.ngc.nvidia.com/nvidia <span class="se">\</span>
   <span class="o">&amp;&amp;</span> helm repo update
</pre></div>
</div>
</li>
<li><p>Specify at least the following options when you install the Operator.
If you want to run Kata Containers by default on all worker nodes, also specify <code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">sandboxWorkloads.defaultWorkload=vm-passthough</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>helm install --wait --generate-name <span class="se">\</span>
   -n gpu-operator --create-namespace <span class="se">\</span>
   nvidia/gpu-operator <span class="se">\</span>
   --set sandboxWorkloads.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
   --set kataManager.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
   --set kataManager.config.runtimeClasses<span class="o">=</span>null
</pre></div>
</div>
<p><em>Example Output</em></p>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">NAME: gpu-operator</span>
<span class="go">LAST DEPLOYED: Tue Jul 25 19:19:07 2023</span>
<span class="go">NAMESPACE: gpu-operator</span>
<span class="go">STATUS: deployed</span>
<span class="go">REVISION: 1</span>
<span class="go">TEST SUITE: None</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="verification">
<h3>Verification<a class="headerlink" href="#verification" title="Permalink to this headline"></a></h3>
<ol class="arabic">
<li><p>Verify that the Kata Manager and VFIO Manager operands are running:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl get pods -n gpu-operator
</pre></div>
</div>
<p><em>Example Output</em></p>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">NAME                                                         READY   STATUS      RESTARTS   AGE</span>
<span class="go">gpu-operator-57bf5d5769-nb98z                                1/1     Running     0          6m21s</span>
<span class="go">gpu-operator-node-feature-discovery-master-b44f595bf-5sjxg   1/1     Running     0          6m21s</span>
<span class="go">gpu-operator-node-feature-discovery-worker-lwhdr             1/1     Running     0          6m21s</span>
<span class="go">nvidia-kata-manager-bw5mb                                    1/1     Running     0          3m36s</span>
<span class="go">nvidia-sandbox-device-plugin-daemonset-cr4s6                 1/1     Running     0          2m37s</span>
<span class="go">nvidia-sandbox-validator-9wjm4                               1/1     Running     0          2m37s</span>
<span class="go">nvidia-vfio-manager-vg4wp                                    1/1     Running     0          3m36s</span>
</pre></div>
</div>
</li>
<li><p>Verify that the <code class="docutils literal notranslate"><span class="pre">kata-qemu-nvidia-gpu</span></code> runtime classes is available:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl get runtimeclass
</pre></div>
</div>
<p><em>Example Output</em></p>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">NAME                       HANDLER                    AGE</span>
<span class="go">kata-qemu-nvidia-gpu       kata-qemu-nvidia-gpu       96s</span>
<span class="go">nvidia                     nvidia                     97s</span>
</pre></div>
</div>
</li>
<li><p>Optional: If you have host access to the worker node, confirm that the host uses the <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> device driver for GPUs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>lspci -nnk -d 10de:
</pre></div>
</div>
<p><em>Example Output</em></p>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">65:00.0 3D controller [0302]: NVIDIA Corporation GA102GL [A10] [10de:2236] (rev a1)</span>
<span class="go">        Subsystem: NVIDIA Corporation GA102GL [A10] [10de:1482]</span>
<span class="hll"><span class="go">        Kernel driver in use: vfio-pci</span>
</span><span class="go">        Kernel modules: nvidiafb, nouveau</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="run-a-sample-workload">
<h2>Run a Sample Workload<a class="headerlink" href="#run-a-sample-workload" title="Permalink to this headline"></a></h2>
<p>A pod specification for a Kata container requires the following:</p>
<ul class="simple">
<li><p>Specify a Kata runtime class.</p></li>
<li><p>Specify a passthrough GPU resource.</p></li>
</ul>
<ol class="arabic">
<li><p>Determine the passthrough GPU resource names:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl get nodes -l nvidia.com/gpu.present -o json | \</span>
<span class="go">  jq &#39;.items[0].status.allocatable |</span>
<span class="go">    with_entries(select(.key | startswith(&quot;nvidia.com/&quot;))) |</span>
<span class="go">    with_entries(select(.value != &quot;0&quot;))&#39;</span>
</pre></div>
</div>
<p><em>Example Output</em></p>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">{</span>
<span class="go">   &quot;nvidia.com/GA102GL_A10&quot;: &quot;1&quot;</span>
<span class="go">}</span>
</pre></div>
</div>
</li>
<li><p>Create a file, such as <code class="docutils literal notranslate"><span class="pre">cuda-vectoradd-kata.yaml</span></code>, like the following example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cuda-vectoradd-kata</span><span class="w"></span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="hll"><span class="w">    </span><span class="nt">cdi.k8s.io/gpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/pgpu=0&quot;</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="nt">io.katacontainers.config.hypervisor.default_memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;16384&quot;</span><span class="w"></span>
</span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="hll"><span class="w">  </span><span class="nt">runtimeClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kata-qemu-nvidia-gpu</span><span class="w"></span>
</span><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OnFailure</span><span class="w"></span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cuda-vectoradd</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvcr.io/nvidia/k8s/cuda-sample:vectoradd-cuda11.7.1-ubuntu20.04&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">limits</span><span class="p">:</span><span class="w"></span>
<span class="hll"><span class="w">        </span><span class="s">&quot;nvidia.com/GA102GL_A10&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
</span></pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">io.katacontainers.config.hypervisor.default_memory</span></code> annotation starts the VM with 16 GB of memory.
Modify the value to accommodate your workload.</p>
</li>
<li><p>Create the pod:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl apply -f cuda-vectoradd-kata.yaml
</pre></div>
</div>
</li>
<li><p>View the logs from pod:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl logs -n default cuda-vectoradd-kata
</pre></div>
</div>
<p><em>Example Output</em></p>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">[Vector addition of 50000 elements]</span>
<span class="go">Copy input data from the host memory to the CUDA device</span>
<span class="go">CUDA kernel launch with 196 blocks of 256 threads</span>
<span class="go">Copy output data from the CUDA device to the host memory</span>
<span class="go">Test PASSED</span>
<span class="go">Done</span>
</pre></div>
</div>
</li>
<li><p>Delete the pod:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl delete -f cuda-vectoradd-kata.yaml
</pre></div>
</div>
</li>
</ol>
<section id="troubleshooting-workloads">
<h3>Troubleshooting Workloads<a class="headerlink" href="#troubleshooting-workloads" title="Permalink to this headline"></a></h3>
<p>If the sample workload does not run, confirm that you labelled nodes to run virtual machines in containers:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl get nodes -l nvidia.com/gpu.workload.config<span class="o">=</span>vm-passthrough
</pre></div>
</div>
<p><em>Example Output</em></p>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">NAME               STATUS   ROLES    AGE   VERSION</span>
<span class="go">kata-worker-1      Ready    &lt;none&gt;   10d   v1.27.3</span>
<span class="go">kata-worker-2      Ready    &lt;none&gt;   10d   v1.27.3</span>
<span class="go">kata-worker-3      Ready    &lt;none&gt;   10d   v1.27.3</span>
</pre></div>
</div>
</section>
</section>
<section id="about-the-pod-annotation">
<h2>About the Pod Annotation<a class="headerlink" href="#about-the-pod-annotation" title="Permalink to this headline"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">cdi.k8s.io/gpu:</span> <span class="pre">&quot;nvidia.com/pgpu=0&quot;</span></code> annotation is used when the pod sandbox is created.
The annotation ensures that the virtual machine created by the Kata runtime is created with
the correct PCIe topology so that GPU passthrough succeeds.</p>
<p>The annotation refers to a Container Device Interface (CDI) device, <code class="docutils literal notranslate"><span class="pre">nvidia.com/pgpu=0</span></code>.
The <code class="docutils literal notranslate"><span class="pre">pgpu</span></code> indicates passthrough GPU and the <code class="docutils literal notranslate"><span class="pre">0</span></code> indicates the device index.
The index is defined by the order that the GPUs are enumerated on the PCI bus.
The index does not correlate to a CUDA index.</p>
<p>The NVIDIA Kata Manager creates a CDI specification on the GPU nodes.
The file includes a device entry for each passthrough device.</p>
<p>In the following sample <code class="docutils literal notranslate"><span class="pre">/var/run/cdi/nvidia.com-pgpu.yaml</span></code> file shows one GPU that
is bound to the VFIO PCI driver:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">cdiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5.0</span><span class="w"></span>
<span class="nt">containerEdits</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span><span class="w"></span>
<span class="nt">devices</span><span class="p">:</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerEdits</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">deviceNodes</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/vfio/10</span><span class="w"></span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia.com/pgpu</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="gpu-operator-kubevirt.html" class="btn btn-neutral float-left" title="GPU Operator with KubeVirt" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="gpu-operator-confidential-containers.html" class="btn btn-neutral float-right" title="GPU Operator with Confidential Containers and Kata" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
<img src="_static/NVIDIA-LogoBlack.svg" class="only-light"/>
<img src="_static/NVIDIA-LogoWhite.svg" class="only-dark"/>
<p class="notices">
<a href="https://www.nvidia.com/en-us/about-nvidia/privacy-policy/" target="_blank">Privacy Policy</a>
|
<a href="https://www.nvidia.com/en-us/about-nvidia/privacy-center/" target="_blank">Manage My Privacy</a>
|
<a href="https://www.nvidia.com/en-us/preferences/start/" target="_blank">Do Not Sell or Share My Data</a>
|
<a href="https://www.nvidia.com/en-us/about-nvidia/terms-of-service/" target="_blank">Terms of Service</a>
|
<a href="https://www.nvidia.com/en-us/about-nvidia/accessibility/" target="_blank">Accessibility</a>
|
<a href="https://www.nvidia.com/en-us/about-nvidia/company-policies/" target="_blank">Corporate Policies</a>
|
<a href="https://www.nvidia.com/en-us/product-security/" target="_blank">Product Security</a>
|
<a href="https://www.nvidia.com/en-us/contact/" target="_blank">Contact</a>
</p>
<p>
  Copyright &#169; 2020-2024, NVIDIA Corporation.
</p>

    <p>
      <span class="lastupdated">Last updated on Sep 10, 2024.
      </span></p>

  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 



</body>
</html>